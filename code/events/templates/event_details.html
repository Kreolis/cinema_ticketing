{% extends "master.html" %}
{% load bootstrap5 %}
{% bootstrap_css %}
{% bootstrap_javascript %}

{% load i18n %}

{% block title %}
    {{ event.name }}
{% endblock %}

{% block content %}
    <!-- Include jQuery library via CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <h1>{{ event.name }}</h1>
    
    <p><strong>{% translate "Start Time" %}:</strong> {{ event.start_time }}</p>
    <p><strong>{% translate "Location" %}:</strong> {{ event.location.name }}</p>
    <p><strong>{% translate "Duration" %}:</strong> {{ event.duration }}</p>
    {% if event.program_link %}
        <p><a href="{{ event.program_link }}">{% translate "View Program" %}</a></p>
    {% endif %}

    <div id="presale-active-content" style="display: none;">
        <p>{% translate "Presale is active. Tickets are sold in presale." %}</p>
        {% if event.allow_door_selling %}
            <p>{% translate "Tickets are also sold at the door after the presale ends at " %} {{ presale_end_time }}</p>
            <p>{% translate "Tickets at the door will be available for" %} <strong>{{ event.presale_ends_before }}h </strong> {% translate "before the event starts at " %} {{ event.start_time }}</p>
        {% endif %}
    </div>
    <div id="presale-inactive-content" style="display: none;">
        {% if event.allow_door_selling %}
            <p>{% translate "Presale period is over. Tickets are only sold at the door." %}</p>
            <p>{% translate "Tickets at the door will be available for" %} <strong>{{ event.presale_ends_before }}h </strong> {% translate "before the event starts at " %} {{ event.start_time }}</p>  
        {% else %}
            <p>{% translate "Presale period is over. Tickets are not anymore available." %}</p>
        {% endif %}
    </div>

    {% if ticket_manager %}
        <a href="{% url 'event_check_in' event.id %}" class="btn btn-primary">{% translate "Go to Ticket Check-In" %}</a>
        <a href="{% url 'event_door_selling' event.id %}" class="btn btn-primary">{% translate "Go to Ticket Door Selling" %}</a>
    {% else %}

        <h2>{% translate "Select Tickets" %}</h2>

        {# Check for form errors and display them #}
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <form method="post" action="">
            {% csrf_token %}

            {# Use bootstrap_form to render the form #}
            {% bootstrap_form form %}

            {# Add a submit button styled with Bootstrap #}
            <div class="mt-3">
                {% bootstrap_button _("Add to Cart") button_type="submit" button_class="btn-primary" %}
                <a href="{% url 'cart_view' %}" class="btn btn-secondary" >{% translate "Go to cart" %}</a>
            </div>

        </form>
    {% endif %}

    <script>
        const presaleEndTime = new Date("{{ presale_end_time|date:'c' }}");
        const presaleStatusElement = document.getElementById('presale-status');
        const presaleActiveContent = document.getElementById('presale-active-content');
        const presaleInactiveContent = document.getElementById('presale-inactive-content');

        function updatePresaleStatus() {
            const now = new Date();
            if (now < presaleEndTime) {
                presaleActiveContent.style.display = 'block';
                presaleInactiveContent.style.display = 'none';
            } else {
                presaleActiveContent.style.display = 'none';
                presaleInactiveContent.style.display = 'block';
            }
        }

        // Update the status immediately and then every minute
        updatePresaleStatus();
        setInterval(updatePresaleStatus, 60000);
    </script>
    
{% endblock %}
